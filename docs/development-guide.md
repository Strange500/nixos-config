# QGroget NixOS Configuration - Development Guide

**Date:** 2026-01-06
**Document Type:** Development Workflow Reference

## Overview

This guide covers how to work with the QGroget NixOS configuration repository, including development workflows, testing, and deployment.

---

## Prerequisites

### Required Software

- **NixOS** installed on target machine, OR
- **Nix** package manager with flakes enabled (for development)
- **Git** for version control
- **SOPS** and **age** for secrets management

### Required Access

- Age private key at `/var/lib/sops/age/keys.txt`
- SSH access to target hosts (for remote deployment)
- Repository clone at `~/nixos` (conventional location)

### Enable Flakes (if needed)

Add to `~/.config/nix/nix.conf` or `/etc/nix/nix.conf`:

```ini
experimental-features = nix-command flakes
```

---

## Getting Started

### 1. Clone Repository

```bash
git clone <repo-url> ~/nixos
cd ~/nixos
```

### 2. Explore Available Configurations

```bash
# Show all flake outputs
nix flake show

# Expected output:
# ├── checks
# │   └── x86_64-linux
# │       ├── jellyfinTest
# │       └── jellyseerrTest
# ├── nixosConfigurations
# │   ├── Clotaire
# │   ├── Clovis
# │   ├── Cube
# │   ├── Server
# │   ├── Septimius
# │   ├── installer
# │   └── pi
# └── packages
#     └── x86_64-linux
#         └── default (neovim)
```

### 3. Build Without Switching (Test)

```bash
# Build a specific host configuration
nix build .#nixosConfigurations.Clovis.config.system.build.toplevel

# This creates a `result` symlink to the built system
```

### 4. Apply Configuration

```bash
# Switch to new configuration (requires sudo on NixOS)
sudo nixos-rebuild switch --flake .#Clovis

# Or test without making it permanent
sudo nixos-rebuild test --flake .#Clovis
```

---

## Common Development Tasks

### Adding a Package to a Desktop Host

**Option 1: Host-specific** (in `hosts/<hostname>/configuration.nix`):
```nix
environment.systemPackages = with pkgs; [
  my-new-package
];
```

**Option 2: All desktops** (in `home.nix`):
```nix
home.packages = lib.mkIf (config.qgroget.nixos.isDesktop) [
  pkgs.my-new-package
];
```

**Option 3: Via module** (in `modules/apps/desktopsApps.nix`):
```nix
environment.systemPackages = lib.mkIf config.qgroget.nixos.apps.someOption [
  pkgs.my-new-package
];
```

### Adding a New Server Service

1. **Create module** at `modules/server/<category>/<service>.nix`:

```nix
{ config, lib, ... }: {
  qgroget.services.myservice = {
    name = "myservice";
    url = "http://127.0.0.1:8080";
    type = "private";
    persistedData = ["/var/lib/myservice"];
  };

  services.myservice = {
    enable = true;
    # ... service configuration
  };
}
```

2. **Import in parent module** (`modules/server/<category>/default.nix`):

```nix
imports = [
  ./myservice.nix
];
```

3. **Deploy and test**:

```bash
sudo nixos-rebuild switch --flake .#Server
```

### Adding a New Host

1. **Create host directory**:

```bash
mkdir -p hosts/NewHost
```

2. **Create required files**:

```
hosts/NewHost/
├── configuration.nix       # Main configuration
├── hardware-configuration.nix  # Generated by nixos-generate-config
├── disk-config.nix         # Disko configuration (optional)
└── settings.nix            # Host-specific qgroget options
```

3. **Minimal `configuration.nix`**:

```nix
{ inputs, ... }: {
  imports = [
    ../global.nix
    inputs.home-manager.nixosModules.default
    inputs.sops-nix.nixosModules.sops
    ./hardware-configuration.nix
  ];
  
  # Host-specific configuration here
}
```

4. **Add to `flake.nix`**:

```nix
nixosConfigurations = {
  # ... existing hosts
  NewHost = mkSystem "NewHost" desktopModules;  # or serverModules
};
```

### Modifying Desktop Environment

Edit `hosts/<hostname>/settings.nix`:

```nix
qgroget.nixos.desktop = {
  desktopEnvironment = "hyprland";  # or "niri", "kde", "gnome"
  loginManager = "dms";             # or "gdm", "ly"
  monitors = [", preferred, auto, 1"];
};
```

### Working with Secrets

**⚠️ Never commit decrypted secrets!**

1. **Edit secrets** (requires SOPS key):

```bash
# Uses sops to decrypt in-place for editing
sops secrets/secrets.yaml
```

2. **Reference secrets in modules**:

```nix
sops.secrets."my/secret/path" = {
  owner = "service-user";
  group = "service-group";
};

# Then reference in service config:
someOption = config.sops.secrets."my/secret/path".path;
```

3. **Never use `show_secret.sh`** - it's for debugging only.

---

## Testing

### Run Integration Tests

```bash
# Jellyfin test
nix build .#checks.x86_64-linux.jellyfinTest

# Jellyseerr test
nix build .#checks.x86_64-linux.jellyseerrTest
```

### Test Configuration Evaluation

```bash
# Check for evaluation errors without building
nix flake check

# Evaluate specific host
nix eval .#nixosConfigurations.Clovis.config.system.build.toplevel
```

### Test in VM

```bash
# Build and run VM for testing
nixos-rebuild build-vm --flake .#Clovis
./result/bin/run-*-vm
```

---

## Deployment

### Local Deployment

```bash
# Build and switch atomically
sudo nixos-rebuild switch --flake .#$(hostname)

# Or specify host explicitly
sudo nixos-rebuild switch --flake .#Clovis
```

### Remote Deployment

```bash
# Deploy to remote host
nixos-rebuild switch --flake .#Server \
  --target-host strange@server.local \
  --use-remote-sudo
```

### Rollback

```bash
# List available generations
sudo nix-env --list-generations --profile /nix/var/nix/profiles/system

# Rollback to previous generation
sudo nixos-rebuild switch --rollback

# Or switch to specific generation
sudo nix-env --profile /nix/var/nix/profiles/system --switch-generation 42
```

---

## Updating Dependencies

### Update All Inputs

```bash
nix flake update
```

### Update Specific Input

```bash
nix flake lock --update-input nixpkgs
nix flake lock --update-input home-manager
```

### Check Outdated Inputs

```bash
# Show current input revisions
nix flake metadata
```

---

## Code Patterns

### Conditional Configuration

```nix
# Based on option
lib.mkIf config.qgroget.nixos.gaming {
  programs.steam.enable = true;
};

# Based on host type
lib.mkIf config.qgroget.nixos.isDesktop {
  # Desktop-only config
};
```

### Service Registration Pattern

```nix
qgroget.services.myservice = {
  name = "myservice";           # Subdomain
  url = "http://127.0.0.1:PORT"; # Backend
  type = "private";             # or "public"
  middlewares = ["SSO"];        # Traefik middlewares
  persistedData = ["/path"];    # Auto-persisted
};
```

### Secrets Pattern

```nix
sops.secrets."server/myservice/password" = {
  owner = "myservice";
  group = "myservice";
};

services.myservice.passwordFile = 
  config.sops.secrets."server/myservice/password".path;
```

---

## Troubleshooting

### Build Fails

```bash
# Check evaluation errors
nix flake check

# Build with verbose output
nix build .#nixosConfigurations.Clovis.config.system.build.toplevel -L

# Check specific service
nix eval .#nixosConfigurations.Server.config.services.jellyfin
```

### Service Not Starting

```bash
# Check service status
systemctl status myservice

# View logs
journalctl -u myservice -f

# For containers
podman logs mycontainer
```

### Secrets Not Available

```bash
# Verify secrets are decrypted
sudo ls -la /run/secrets/

# Check SOPS key exists
ls -la /var/lib/sops/age/keys.txt

# Verify secret ownership
stat /run/secrets/my/secret
```

### Impermanence Issues

```bash
# Check what's persisted
ls -la /persist/

# Verify mount
mount | grep persist
```

---

## File Locations Quick Reference

| Purpose | Location |
|---------|----------|
| Entry point | `flake.nix` |
| Global options | `settings.nix` |
| Host configs | `hosts/<hostname>/` |
| Server modules | `modules/server/` |
| Desktop modules | `modules/desktop/` |
| Application modules | `modules/apps/` |
| Secrets (encrypted) | `secrets/secrets.yaml` |
| Age key | `/var/lib/sops/age/keys.txt` |
| System generations | `/nix/var/nix/profiles/system` |

---

## Best Practices

1. **Test before deploying**: Use `nix build` or `nixos-rebuild test`
2. **Commit frequently**: Small, atomic changes are easier to debug
3. **Never commit secrets**: Use SOPS for all sensitive data
4. **Document changes**: Update relevant docs when adding features
5. **Use modules**: Prefer modular configuration over inline code
6. **Check flake health**: Run `nix flake check` before commits

---

_Generated using BMAD Method `document-project` workflow_
